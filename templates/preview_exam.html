{% extends "base.html" %}
{% load static %}

{% block title %}Generated Exams{% endblock %}

{% block extra_css %}
<style>
    /* Styling reused from generate_exam but adapted for preview */
    .preview-container {
        max-width: 1000px;
        margin: 0 auto;
        padding: 2rem 1rem;
    }
    
    #exam-header-container { text-align: center; margin-bottom: 2rem; }
    .exam-title-text { font-size: 2rem; font-weight: 800; color: #111827; }
    .exam-summary-text { font-size: 1.1rem; color: #4b5563; max-width: 800px; margin: 0.5rem auto; }

    #exam-questions-container {
        background: white;
        border: 1px solid #e5e7eb;
        border-radius: 12px;
        padding: 4rem;
        box-shadow: 0 4px 6px -1px rgba(0,0,0,0.05);
        counter-reset: q-counter;
    }
    .question-item { margin-bottom: 3rem; position: relative; padding-left: 2.5rem; }
    .question-item::before {
        counter-increment: q-counter;
        content: "Q" counter(q-counter) ".";
        position: absolute; left: 0; top: 0;
        font-weight: 800; color: #4f46e5; font-size: 1.1rem;
    }
    .q-text { font-size: 1.1rem; font-weight: 600; color: #1f2937; margin-bottom: 1rem; }
    .opt { padding: 0.75rem 1rem; border: 1px solid #e2e8f0; border-radius: 8px; margin-bottom: 0.5rem; background: #f8fafc; color: #334155; }

    .action-bar {
        display: flex;
        justify-content: space-between;
        align-items: center;
        margin-bottom: 2rem;
    }
    
    .back-btn {
        text-decoration: none;
        color: #6b7280;
        font-weight: 600;
        display: flex;
        align-items: center;
        gap: 0.5rem;
    }
    .back-btn:hover { color: #111827; }

    .assign-btn {
        padding: 0.75rem 1.5rem;
        background: #4f46e5;
        color: white;
        border: none;
        border-radius: 8px;
        font-weight: 600;
        cursor: pointer;
        transition: background 0.2s;
    }
    .assign-btn:hover { background: #4338ca; }

    /* Modal Styles */
    .modal-overlay {
        display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%;
        background: rgba(0, 0, 0, 0.5); z-index: 100;
        align-items: center; justify-content: center; backdrop-filter: blur(2px);
    }
    .modal-content {
        background: white; padding: 2.5rem; border-radius: 16px; width: 100%; max-width: 500px;
        box-shadow: 0 25px 50px -12px rgba(0, 0, 0, 0.25);
    }
    .custom-msg-box {
        width: 100%; padding: 0.75rem; border: 1px solid #d1d5db; border-radius: 8px;
        font-family: inherit; font-size: 0.95rem; resize: vertical; margin-bottom: 1.5rem;
    }
</style>
{% endblock %}

{% block content %}
<div class="preview-container">
    
    <div class="action-bar">
        <a href="{% url 'previous_exams' %}" class="back-btn">
            ‚Üê Back to Generated Exams
        </a>
        <button class="assign-btn" onclick="openAssignModal()">üìù Assign This Exam</button>
    </div>

    <div id="exam-header-container">
        {{ exam_content.header_html|safe }}
    </div>
    
    <div id="exam-questions-container">
        {{ exam_content.questions_html|safe }}
    </div>

</div>

<div id="assign-modal" class="modal-overlay">
    <div class="modal-content">
        <h2 style="font-size: 1.5rem; font-weight: 800; color: #111827; margin-bottom: 1.5rem;">Assign Exam</h2>
        
        <label style="display:block; margin-bottom: 0.5rem; font-weight: 600; color: #374151;">Select Candidate</label>
        <select id="assign-user" style="width: 100%; padding: 0.75rem; border: 1px solid #d1d5db; border-radius: 8px; margin-bottom: 1.5rem; font-size: 1rem;">
            {% for user in candidates %}
            <option value="{{ user.id }}">{{ user.username }} ({{ user.email }})</option>
            {% endfor %}
        </select>

        <label style="display:block; margin-bottom: 0.5rem; font-weight: 600; color: #374151;">Temp Password / Note</label>
        <textarea id="assign-message" class="custom-msg-box" rows="4" placeholder="Hello, here is your temporary password: ..."></textarea>

        <div style="display: flex; gap: 1rem;">
            <button onclick="closeAssignModal()" style="flex:1; padding: 0.75rem; background: #f3f4f6; color: #374151; border: 1px solid #e5e7eb; border-radius: 8px; cursor: pointer; font-weight: 600;">Cancel</button>
            <button onclick="sendAssignment()" style="flex:1; padding: 0.75rem; background: #4f46e5; color: white; border: none; border-radius: 8px; cursor: pointer; font-weight: 600;">Confirm & Send</button>
        </div>
    </div>
</div>

<script>
    const currentSessionId = "{{ exam.id }}";

    function openAssignModal() { document.getElementById('assign-modal').style.display = 'flex'; }
    function closeAssignModal() { document.getElementById('assign-modal').style.display = 'none'; }
    
    function sendAssignment() {
        const userId = document.getElementById('assign-user').value;
        const message = document.getElementById('assign-message').value;
        
        if(!currentSessionId) return alert("Error: Exam ID missing.");

        const formData = new FormData();
        formData.append('exam_id', currentSessionId);
        formData.append('user_id', userId);
        formData.append('message', message); 

        fetch("{% url 'assign_exam_api' %}", { 
            method: "POST", 
            body: formData, 
            headers: {"X-CSRFToken": "{{ csrf_token }}"} 
        })
        .then(res => res.json())
        .then(data => {
            alert(data.message);
            closeAssignModal();
        })
        .catch(err => {
            console.error(err);
            alert("Error assigning exam.");
        });
    }
</script>
{% endblock %}