{% extends "base.html" %}
{% load static %}

{% block title %}Exam in Progress{% endblock %}

{% block extra_css %}
<style>
    /* HIDE SIDEBAR & NAV for focus mode */
    .sidebar, .navbar { display: none !important; }
    main { margin-left: 0 !important; padding: 0 !important; width: 100%; max-width: 100%; }
    
    body { background-color: #f3f4f6; }

    /* TIMER HEADER */
    .exam-timer-bar {
        position: fixed;
        top: 0; left: 0; width: 100%;
        background: #1f2937;
        color: white;
        padding: 1rem 2rem;
        display: flex;
        justify-content: space-between;
        align-items: center;
        z-index: 1000;
        box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1);
        box-sizing: border-box; /* Fix padding pushing width */
    }

    .timer-display {
        font-family: 'Courier New', Courier, monospace;
        font-size: 1.5rem;
        font-weight: 700;
        color: #fbbf24; /* Amber warning color */
        background: rgba(255,255,255,0.1);
        padding: 0.5rem 1rem;
        border-radius: 8px;
        min-width: 120px;
        text-align: center;
    }

    .exam-container {
        display: grid;
        grid-template-columns: 280px 1fr;
        gap: 2rem;
        max-width: 1400px;
        margin: 6rem auto 4rem auto; /* Top margin for sticky header */
        padding: 0 2rem;
        min-height: calc(100vh - 120px);
    }

    /* --- SIDEBAR: NAVIGATOR --- */
    .question-nav-card {
        background: white;
        border: 1px solid #e5e7eb;
        border-radius: 16px;
        padding: 1.5rem;
        height: auto;
        max-height: calc(100vh - 8rem);
        overflow-y: auto;
        box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.05);
        position: sticky;
        top: 6rem; /* Adjusted for timer bar */
    }
    .nav-title {
        font-size: 1.1rem;
        font-weight: 700;
        color: #1f2937;
        margin-bottom: 1.5rem;
        border-bottom: 1px solid #f3f4f6;
        padding-bottom: 1rem;
    }
    .nav-grid {
        display: flex;
        flex-wrap: wrap;
        gap: 0.5rem;
        justify-content: flex-start;
    }
    .nav-item {
        width: 40px;
        height: 40px;
        display: flex;
        align-items: center;
        justify-content: center;
        border: 1px solid #d1d5db;
        border-radius: 8px;
        font-weight: 600;
        color: #6b7280;
        cursor: pointer;
        transition: all 0.2s;
        font-size: 0.9rem;
    }
    .nav-item:hover { border-color: #4f46e5; color: #4f46e5; }
    .nav-item.active { background-color: #e0e7ff; border-color: #4f46e5; color: #4338ca; }
    .nav-item.answered { background-color: #4f46e5; border-color: #4f46e5; color: white; }

    /* --- MAIN CONTENT: QUESTION --- */
    .question-area {
        background: white;
        border: 1px solid #e5e7eb;
        border-radius: 16px;
        padding: 3rem;
        display: flex;
        flex-direction: column;
        justify-content: space-between;
        box-shadow: 0 10px 15px -3px rgba(0, 0, 0, 0.05);
        min-height: 600px;
    }
    
    .question-step { display: none; animation: fadeIn 0.3s ease-in-out; }
    .question-step.visible { display: block; }

    .q-meta {
        font-size: 0.9rem;
        color: #6b7280;
        margin-bottom: 1rem;
        text-transform: uppercase;
        letter-spacing: 0.05em;
        font-weight: 600;
    }
    .q-text {
        font-size: 1.5rem;
        font-weight: 700;
        color: #111827;
        margin-bottom: 2rem;
        line-height: 1.4;
    }

    .options-list { display: flex; flex-direction: column; gap: 1rem; }
    .option-label {
        display: flex;
        align-items: center;
        padding: 1rem 1.5rem;
        border: 1px solid #e5e7eb;
        border-radius: 12px;
        cursor: pointer;
        transition: all 0.2s;
    }
    .option-label:hover { background-color: #f9fafb; border-color: #d1d5db; }
    input[type="radio"]:checked + span { font-weight: 600; color: #4338ca; }
    .option-label:has(input:checked) { border-color: #4f46e5; background-color: #eef2ff; box-shadow: 0 0 0 1px #4f46e5; }

    input[type="radio"] {
        width: 1.25em;
        height: 1.25em;
        margin-right: 1rem;
        accent-color: #4f46e5;
    }

    /* --- FOOTER BUTTONS --- */
    .exam-footer {
        margin-top: 3rem;
        padding-top: 2rem;
        border-top: 1px solid #f3f4f6;
        display: flex;
        justify-content: space-between;
        align-items: center;
    }
    .btn-nav {
        padding: 0.75rem 2rem;
        border-radius: 8px;
        font-weight: 600;
        cursor: pointer;
        transition: all 0.2s;
        font-size: 1rem;
        border: none;
    }
    .btn-prev { background: #f3f4f6; color: #374151; }
    .btn-prev:hover { background: #e5e7eb; }
    .btn-prev:disabled { opacity: 0.5; cursor: not-allowed; }

    .btn-next { background: #4f46e5; color: white; display: inline-flex; align-items: center; gap: 0.5rem; }
    .btn-next:hover { background: #4338ca; transform: translateY(-1px); }

    .btn-finish { 
        background: #10b981; 
        color: white; 
        display: none; 
        align-items: center; gap: 0.5rem;
        padding: 0.75rem 2rem;
        border-radius: 8px;
        font-weight: 600;
        cursor: pointer;
        border: none;
        font-size: 1rem;
    }
    .btn-finish:hover { background: #059669; transform: translateY(-1px); }

    /* ABORT BUTTON */
    .btn-abort {
        background: white;
        color: #ef4444;
        border: 1px solid #fee2e2;
        padding: 0.75rem 1.5rem;
        border-radius: 8px;
        font-weight: 600;
        cursor: pointer;
        font-size: 0.9rem;
    }
    .btn-abort:hover { background: #fef2f2; border-color: #fecaca; }

    /* --- MODAL --- */
    .modal-overlay {
        display: none;
        position: fixed; top: 0; left: 0; width: 100%; height: 100%;
        background: rgba(0, 0, 0, 0.5);
        z-index: 2000;
        align-items: center; justify-content: center;
        backdrop-filter: blur(4px);
    }
    .modal-card {
        background: white;
        padding: 2.5rem;
        border-radius: 20px;
        width: 100%;
        max-width: 500px;
        text-align: center;
        box-shadow: 0 25px 50px -12px rgba(0, 0, 0, 0.25);
        animation: scaleIn 0.2s ease-out;
    }
    .modal-title { font-size: 1.5rem; font-weight: 800; color: #111827; margin-bottom: 1rem; }
    .summary-table { width: 100%; margin: 1.5rem 0; border-collapse: collapse; }
    .summary-table td { padding: 0.75rem; border-bottom: 1px solid #f3f4f6; text-align: left; }
    .summary-table td:last-child { text-align: right; font-weight: 700; color: #111827; }
    
    .warning-text { color: #b91c1c; background: #fef2f2; padding: 1rem; border-radius: 8px; font-size: 0.9rem; margin-bottom: 2rem; border: 1px solid #fecaca; }
    .modal-actions { display: flex; gap: 1rem; }
    .btn-confirm { flex: 1; padding: 0.8rem; background: #4f46e5; color: white; border: none; border-radius: 8px; font-weight: 600; cursor: pointer; }
    .btn-cancel { flex: 1; padding: 0.8rem; background: white; color: #374151; border: 1px solid #d1d5db; border-radius: 8px; font-weight: 600; cursor: pointer; }

    @keyframes fadeIn { from { opacity: 0; transform: translateY(5px); } to { opacity: 1; transform: translateY(0); } }
    @keyframes scaleIn { from { transform: scale(0.95); opacity: 0; } to { transform: scale(1); opacity: 1; } }
    @keyframes pulse { 0% { opacity: 1; } 50% { opacity: 0.5; } 100% { opacity: 1; } }
    
    @media (max-width: 1024px) { 
        .exam-container { grid-template-columns: 1fr; margin-top: 5rem; } 
        .question-nav-card { display: none; } 
        .exam-timer-bar { padding: 0.75rem 1rem; font-size: 0.9rem; }
    }
</style>
{% endblock %}

{% block content %}
<div class="exam-timer-bar">
    <div style="font-size: 1.1rem; font-weight: 600; display: flex; align-items: center; gap: 0.5rem;">
        <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M22 12h-4l-3 9L9 3l-3 9H2"/></svg>
        Technical Assessment
    </div>
    <div style="display:flex; align-items:center; gap:1rem;">
        <span style="font-size: 0.9rem; opacity: 0.9;">Time Remaining:</span>
        <div id="timer" class="timer-display">--:--</div>
    </div>
</div>

<form id="examForm" method="POST" class="exam-container" action="{% url 'take_exam' assignment.id %}">
    {% csrf_token %}

    <div class="question-nav-card">
        <div class="nav-title">Question Navigator</div>
        <div class="nav-grid">
            {% for q in questions %}
            <div class="nav-item {% if forloop.first %}active{% endif %}" id="nav-{{ forloop.counter0 }}" onclick="jumpTo({{ forloop.counter0 }})">
                {{ forloop.counter }}
            </div>
            {% endfor %}
        </div>
        <div style="margin-top: 2rem; padding-top: 1rem; border-top: 1px solid #f3f4f6;">
            <div style="display:flex; align-items:center; gap:0.5rem; margin-bottom:0.5rem; font-size:0.85rem; color:#6b7280;">
                <span style="width:12px; height:12px; background:#4f46e5; border-radius:2px;"></span> Answered
            </div>
            <div style="display:flex; align-items:center; gap:0.5rem; font-size:0.85rem; color:#6b7280;">
                <span style="width:12px; height:12px; background:#e0e7ff; border:1px solid #4f46e5; border-radius:2px;"></span> Current
            </div>
        </div>
    </div>

    <div class="question-area">
        
        <div id="questions-wrapper">
            {% for q in questions %}
            <div class="question-step {% if forloop.first %}visible{% endif %}" data-index="{{ forloop.counter0 }}">
                <div class="q-meta">Question {{ forloop.counter }} of {{ questions|length }}</div>
                <div class="q-text">{{ q.question_text }}</div>
                
                <div class="options-list">
                    {% for opt in q.options %}
                    <label class="option-label">
                        <input type="radio" name="answer_{{ q.id }}" value="{{ opt }}" onchange="markAnswered({{ forloop.parentloop.counter0 }})">
                        <span>{{ opt }}</span>
                    </label>
                    {% endfor %}
                </div>
            </div>
            {% endfor %}
        </div>

        <div class="exam-footer">
            <button type="button" class="btn-abort" onclick="openAbortModal()">Abort Exam</button>

            <div style="display: flex; gap: 1rem;">
                <button type="button" id="btnPrev" class="btn-nav btn-prev" onclick="changeQuestion(-1)" disabled>‚Üê Previous</button>
                <button type="button" id="btnNext" class="btn-nav btn-next" onclick="changeQuestion(1)">Next Question ‚Üí</button>
                <button type="button" id="btnFinish" class="btn-finish" onclick="openFinishModal()">Finish Exam üèÅ</button>
            </div>
        </div>
    </div>

    <div id="submitModal" class="modal-overlay">
        <div class="modal-card">
            <div class="modal-title" id="modalTitle">Finish & Submit?</div>
            <p style="color: #6b7280;" id="modalDesc">You are about to submit your exam.</p>
            
            <table class="summary-table">
                <tr><td>Total Questions</td><td>{{ questions|length }}</td></tr>
                <tr><td>Attempted</td><td id="attemptedCount">0</td></tr>
                <tr><td>Pending</td><td id="pendingCount">0</td></tr>
            </table>

            <div class="warning-text" id="modalWarning">
                Do you really want to submit exam?
            </div>

            <div class="modal-actions">
                <button type="button" class="btn-cancel" onclick="closeFinishModal()">Cancel</button>
                <button type="submit" class="btn-confirm" id="confirmBtn">Yes, Submit Exam</button>
            </div>
        </div>
    </div>

</form>

<script>
    // --- NAVIGATION LOGIC ---
    let currentIndex = 0;
    const totalQuestions = {{ questions|length }};
    
    function updateUI() {
        document.querySelectorAll('.question-step').forEach((el, idx) => {
            el.classList.toggle('visible', idx === currentIndex);
        });
        document.querySelectorAll('.nav-item').forEach((el, idx) => {
            if (idx === currentIndex) el.classList.add('active');
            else el.classList.remove('active');
        });
        document.getElementById('btnPrev').disabled = (currentIndex === 0);
        
        const btnNext = document.getElementById('btnNext');
        const btnFinish = document.getElementById('btnFinish');

        if (currentIndex === totalQuestions - 1) {
            btnNext.style.display = 'none';
            btnFinish.style.display = 'inline-flex';
        } else {
            btnNext.style.display = 'inline-flex';
            btnFinish.style.display = 'none';
        }
    }

    function changeQuestion(dir) {
        if (dir === 1 && currentIndex < totalQuestions - 1) {
            currentIndex++;
        } else if (dir === -1 && currentIndex > 0) {
            currentIndex--;
        }
        updateUI();
    }

    function jumpTo(index) {
        currentIndex = index;
        updateUI();
    }

    function markAnswered(index) {
        document.getElementById('nav-' + index).classList.add('answered');
    }

    function calculateStats() {
        const attempted = document.querySelectorAll('input[type="radio"]:checked').length;
        const pending = totalQuestions - attempted;
        document.getElementById('attemptedCount').innerText = attempted;
        document.getElementById('pendingCount').innerText = pending;
    }

    function openFinishModal() {
        calculateStats();
        // Reset texts for Finish
        document.getElementById('modalTitle').innerText = "Finish & Submit?";
        document.getElementById('modalDesc').innerText = "You are about to submit your exam.";
        document.getElementById('modalWarning').innerText = "Do you really want to submit exam?";
        document.getElementById('confirmBtn').innerText = "Yes, Submit Exam";
        
        document.getElementById('submitModal').style.display = 'flex';
    }

    function openAbortModal() {
        calculateStats();
        // Update texts for Abort
        document.getElementById('modalTitle').innerText = "Abort Exam?";
        document.getElementById('modalDesc').innerText = "Aborting will submit your current progress.";
        document.getElementById('modalWarning').innerText = "‚ö†Ô∏è Warning: This will end the exam immediately. Unanswered questions will be marked incorrect.";
        document.getElementById('confirmBtn').innerText = "Yes, Abort & Save";

        document.getElementById('submitModal').style.display = 'flex';
    }

    function closeFinishModal() {
        document.getElementById('submitModal').style.display = 'none';
    }

    // --- TIMER LOGIC (NEW) ---
    let timeRemaining = {{ timer_seconds }};
    const timerDisplay = document.getElementById('timer');
    const examForm = document.getElementById('examForm');

    function updateTimer() {
        if (timeRemaining <= 0) {
            timerDisplay.innerText = "00:00";
            timerDisplay.style.color = "#ef4444"; // Red alert
            clearInterval(timerInterval);
            
            // Auto Submit
            alert("Time's up! Your exam is being submitted automatically.");
            examForm.submit();
            return;
        }

        const minutes = Math.floor(timeRemaining / 60);
        const seconds = timeRemaining % 60;
        
        const minStr = minutes < 10 ? "0" + minutes : minutes;
        const secStr = seconds < 10 ? "0" + seconds : seconds;
        
        timerDisplay.innerText = `${minStr}:${secStr}`;
        
        // Visual warning at 1 minute
        if (timeRemaining < 60) {
            timerDisplay.style.color = "#ef4444"; 
            timerDisplay.style.animation = "pulse 1s infinite";
        }

        timeRemaining--;
    }

    const timerInterval = setInterval(updateTimer, 1000);
    updateTimer(); // Initial call
    updateUI(); // Init Nav
    
    // Prevent accidental navigation
    window.onbeforeunload = function() {
       // Optional: return "Are you sure you want to leave?";
    };
</script>
{% endblock %}